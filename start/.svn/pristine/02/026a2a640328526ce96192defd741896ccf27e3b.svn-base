<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.2//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rkjh.eschool.dao.NotifyDao">

	<select id="list" resultType="java.util.Map" parameterType="java.util.Map">
	    select id,title,sender,array_to_string(receiver,',') receiver,to_char(create_date, 'YYYY-MM-DD HH24:MI:SS') create_date,content from notify 
	    where 1=1 
	    <if test="keyword != null and keyword !=''">  
	        and title like '%'||#{keyword}||'%'
	    </if>  
	    <if test="dateBegin != null and dateBegin !=''">  
	        and to_char(create_date, 'YYYY-MM-DD') >= #{dateBegin}
	    </if>  
	    <if test="dateEnd != null and dateEnd !=''">
	        and to_char(create_date, 'YYYY-MM-DD') &lt;= #{dateEnd}
	    </if> 
	    <if test="persionId != null and persionId !=0">  
	        and receiver @> array[#{persionId}]
	    </if>  
	    limit  #{size} offset #{start}
	</select>
	
	<select id="listCount" resultType="java.lang.Integer" parameterType="java.util.Map">
	    select count(1) from notify 
	    where 1=1 
	    <if test="keyword != null and keyword !=''">  
	        and title like '%'||#{keyword}||'%'
	    </if>  
	    <if test="dateBegin != null and dateBegin !=''">  
	        and to_char(create_date, 'YYYY-MM-DD') >= #{dateBegin}
	    </if>  
	    <if test="dateEnd != null and dateEnd !=''">
	        and to_char(create_date, 'YYYY-MM-DD') &lt;= #{dateEnd}
	    </if> 
	    <if test="persionId !=0">  
	        and receiver @> array[#{persionId}]
	    </if>  
	</select>
	
	<select id="getById" resultType="java.util.Map" parameterType="java.util.Map">
	    select id,title,sender,array_to_string(receiver,',') receiver,to_char(create_date, 'YYYY-MM-DD HH24:MI:SS') create_date,content from notify 
	    where id=#{id}
	</select>
	
	<select id="getNodeName" resultType="java.lang.String" parameterType="java.util.Map">
	    select c.name from person_station a,sys_station b,node c where a.station=b.id and b.node=c.id and a.person = #{person}
	</select>
	
	<insert id="add" useGeneratedKeys="true" keyProperty="id" parameterType="java.util.Map">
		insert into notify(id,title,sender,receiver,create_date,content)
 			values(DEFAULT,#{title},#{sender},ARRAY[
 			<foreach collection="receiver" index="index" item="item" separator=",">   
       	 		#{item}   
    		</foreach>
 			],#{create_date},#{content})
	</insert>
</mapper>